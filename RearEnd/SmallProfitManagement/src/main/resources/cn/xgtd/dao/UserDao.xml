<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.xgtd.dao.UserDao">

    <resultMap id="findUserRoleMap" type="cn.xgtd.domain.user.User">
        <id property="uId" column="u_id"></id>
        <result property="userName" column="user_name"></result>
        <result property="createTime" column="mu_create_time"></result>
        <result property="roleId" column="role_id"></result>
        <result property="email" column="email"></result>
        <result property="phone" column="phone"></result>
        <result property="creator" column="creator"></result>
        <result property="lastTime" column="mu_last_time"></result>
        <result property="lastAuthor" column="mu_last_author"></result>
        <result property="lastAuthorName" column="ms_last_name"></result>
     <association property="role" resultMap="roleMap">
     </association>

</resultMap>

<resultMap id="roleMap" type="cn.xgtd.domain.user.Role">
        <id property="rId" column="r_id"></id>
        <result property="databaseMenus" column="menus"></result>
        <result property="name" column="name"></result>
        <result property="createTime" column="mr_create_time"></result>
        <result property="createAuthor" column="create_author"></result>
        <result property="createAuthorId" column="create_author_id"></result>
        <result property="lastTime" column="mr_last_time"></result>
        <result property="lastAuthor" column="mr_last_author"></result>
</resultMap>


    <!--查询管理用户密码-->
    <select id="findPassword" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT `password` FROM  management_user WHERE user_name = #{userName}
    </select>
    <!--询用户以用户角色-->
    <select id="findUserRole" parameterType="java.lang.String" resultMap="findUserRoleMap">
    SELECT
        mu.u_id,
        mu.user_name,
        mu.create_time AS mu_create_time,
        mu.role_id,
        mu.email,
        mu.phone,
        mu.creator,
        mu.last_time AS mu_last_time,
        mu.last_author AS mu_last_author,
        mr.r_id,
        mr.menus,
        mr.NAME,
        mr.create_time AS mr_create_time,
        mr.create_author,
        mr.create_author_id,
        mr.last_time AS mr_last_time,
        mr.last_author AS mr_last_author,
		ms.user_name AS ms_last_name
        FROM
        management_user mu
		LEFT JOIN
		 management_user ms
		ON mu.last_author = ms.u_id
        LEFT JOIN
        management_role mr
        ON mu.role_id = mr.r_id
        WHERE
         mu.user_name =  #{userName}

     </select>

     <!--查询用户名是否重复-->
       <select id="findUserRepeat" resultType="java.lang.Integer">
            select count(user_name) FROM management_user WHERE user_name = #{userName}
        </select>

      <!--新增用户-->
     <insert id="addUser">
            insert into management_user (user_name,password,create_time,email,phone,creator)
            values(#{userName},#{password},#{createTime},#{email},#{phone},#{creator})
       </insert>

       <!--修改角色关系-->
       <update id="updateRoleRelationship">
            update management_user set role_id = #{rId} where u_id = #{uId}
       </update>

       <!--查询创建的用户以及子用户-->
       <select id="findUser" resultMap="findUserRoleMap">
            SELECT
                mu.u_id,
                mu.user_name,
                mu.create_time AS mu_create_time,
                mu.role_id,
                mu.email,
                mu.phone,
                mu.creator,
                mu.last_time AS mu_last_time,
                mu.last_author AS mu_last_author,
                mr.r_id,
                mr.menus,
                mr.NAME,
                mr.create_time AS mr_create_time,
                mr.create_author,
                mr.create_author_id,
                mr.last_time AS mr_last_time,
                mr.last_author AS mr_last_author,
                ms.user_name AS ms_last_name
            FROM
                management_user mu
                LEFT JOIN management_user ms ON mu.last_author = ms.u_id
                LEFT JOIN management_role mr ON mu.role_id = mr.r_id
            WHERE
                mu.u_id IN (
                SELECT
                    descendant_id
                FROM
                ( SELECT descendant_id FROM management_role_relationship WHERE FIND_IN_SET( descendant_id, GET_CHILD_NODE ( #{uId} )) AND descendant_id != 10001 ) AS role_relationship
                )
       </select>



</mapper>