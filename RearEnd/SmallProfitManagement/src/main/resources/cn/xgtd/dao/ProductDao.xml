<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.xgtd.dao.ProductDao">

    <!--商品详详细map-->
    <resultMap id="ProductDatailsMap" type="cn.xgtd.domain.product.ProductDetails">
        <id property="productId" column="ProductId"></id>
        <result property="productName" column="ProductName"></result>
        <result property="productSales" column="ProductSales"></result>
        <result property="weight" column="ProductWeight"></result>
        <result property="video" column="ProductVideo"></result>
        <result property="salesPrice" column="SalesPrice"></result>
        <result property="productPrice" column="ProductPrice"></result>
        <result property="productInventory" column="ProductInventory"></result>
        <result property="spikePrice" column="SpikePrice"></result>
        <result property="inventorys" column="ProductInventory"></result>
        <result property="productDescription" column="productDescription"></result>
        <result property="productAfterSale" column="productAfterSale"></result>
        <result property="productParameter" column="productParameter"></result>

        <association property="productClassify" javaType="cn.xgtd.domain.product.ProductClassify" resultMap="productClassifyMap">
        </association>
        <!--映射配置集合-->
        <collection property="productContexts" resultMap="productContextMap">
        </collection>


        <!--映射图片集合-->
        <collection property="imageSite" ofType="java.lang.String">
            <constructor>
                <arg column="ImageSite"></arg>
            </constructor>
        </collection>

    </resultMap>

    <resultMap id="productContextMap" type="cn.xgtd.domain.product.ProductContext">
     <id property="attributeId" column="attributeId"></id>
            <result property="attributeContent" column="attributeContent"></result>
            <result property="attributeType" column="title"></result>
            <result property="titleId" column="attributeType"></result>
    </resultMap>

    <!--商品分类map-->
    <resultMap id="productClassifyMap" type="cn.xgtd.domain.product.ProductClassify">
        <result property="productPrimaryId" column="product_primary_id"></result>
        <result property="primaryContent" column="category_content"></result>
        <result property="productSecondaryId" column="product_secondary_id"></result>
        <result property="secondaryContent" column="secondary_content"></result>
        <result property="productFinalId" column="product_final_id"></result>
        <result property="finalContent" column="final_content"></result>
    </resultMap>

      <!--一级分类-->
    <resultMap id="findCategoryPrimaryMap" type="cn.xgtd.domain.product.ProductCategory" >
        <result property="categoryId" column="product_primary_id"></result>
        <result property="categoryContent" column="category_content"></result>
        <collection property="children" ofType="cn.xgtd.domain.product.ProductCategory">
          <result property="categoryId" column="product_secondary_id"></result>
          <result property="categoryContent" column="secondary_content"></result>
            <collection property="children" ofType="cn.xgtd.domain.product.ProductCategory">
                <result property="categoryId" column="product_final_id"></result>
                <result property="categoryContent" column="final_content"></result>
            </collection>
        </collection>
    </resultMap>

    <!--商品配置map-->
    <resultMap id="ProductDistinctionMap" type="cn.xgtd.domain.product.ProductDistinction">
        <result property="sizeId" column="sizeId"></result>
        <result property="sizeContent" column="ps_attributeContent"></result>
        <result property="colourId" column="colourId"></result>
        <result property="colourContent" column="pc_attributeContent"></result>
        <result property="comboId" column="comboId"></result>
        <result property="comboContent" column="pcb_attributeContent"></result>
        <result property="specificationId" column="specificationId"></result>
        <result property="specificationContent" column="psp_attributeContent"></result>
        <result property="tasteId" column="tasteId"></result>
        <result property="tasteContent" column="pt_attributeContent"></result>
        <result property="kindId" column="kindId"></result>
        <result property="kindContent" column="pk_attributeContent"></result>
        <result property="versionId" column="versionId"></result>
        <result property="versionContent" column="pv_attributeContent"></result>
        <result property="colourId" column="colourId"></result>
        <result property="productPrice" column="productPrice"></result>
        <result property="productInventory" column="productInventory"></result>
        <result property="productSales" column="productSales"></result>
    </resultMap>

    <!--查询商品总数量-->
    <select id="findFavoriteQuantity" resultType="java.lang.Integer">
        SELECT count(productId) FROM ProductBasis
    </select>

    <!--查询商品详细信息-->
    <select id="fendProduct" resultMap="ProductDatailsMap">
         SELECT
            pb.id,
            pb.ProductId,
            pb.ProductName,
            pb.ProductVideo,
            pb.ProductWeight,
            pb.prodcutPrimaryCategory,
            pb.productFinalCategory,
            pb.productFinalCategory,
            pb.productPageviews,
            pb.productDescription,
            pb.productAfterSale,
            pb.productParameter,
            pp.ProductPrice,
            pp.SpikePrice,
            pp.SalesPrice,
            pp.ProductSales,
            pp.ProductInventory,
            pi.ImageSite,
            pa.attributeContent,
            pa.attributeId,
            pat.title,
            pa.attributeType,
            ppc.product_primary_id,
            ppc.category_content,
            psc.product_secondary_id,
            psc.secondary_content,
            pfc.product_final_id,
            pfc.final_content
        FROM
            ProductBasis pb
            LEFT JOIN ProductPrice pp ON pb.ProductId = pp.ProductId
            LEFT JOIN ProductImage pi ON pb.ProductId = pi.ProductId
            LEFT JOIN productAttribute pa ON pb.ProductId = pa.ProductId
            LEFT JOIN attributeType pat ON pa.attributeType = pat.attributeTypeId
            LEFT JOIN product_primary_category ppc ON pb.prodcutPrimaryCategory = ppc.product_primary_id
            LEFT JOIN product_secondary_category psc ON pb.productSecondaryCategory = psc.product_secondary_id
            LEFT JOIN product_final_category pfc ON pb.productFinalCategory = pfc.product_final_id
        WHERE
            pb.ProductId IN ( SELECT productId FROM ( SELECT productId FROM ProductBasis LIMIT #{start}, #{pageSize} ) AS productId )
    </select>

    <!--查询商品属性 销量 库存 不同-->
    <select id="findProductDistinction" resultMap="ProductDistinctionMap">
         SELECT
            pd.*,
            ps.attributeContent AS ps_attributeContent,
            pc.attributeContent AS pc_attributeContent,
            pcb.attributeContent AS pcb_attributeContent,
            psp.attributeContent AS psp_attributeContent,
            pt.attributeContent AS pt_attributeContent,
            pk.attributeContent AS pk_attributeContent,
            pv.attributeContent AS pv_attributeContent
        FROM
            productDistinction pd
            LEFT JOIN productAttribute ps ON pd.sizeId = ps.attributeId
            LEFT JOIN productAttribute pc ON pd.colourId = pc.attributeId
            LEFT JOIN productAttribute pcb ON pd.comboId = pcb.attributeId
            LEFT JOIN productAttribute psp ON pd.specificationId = psp.attributeId
            LEFT JOIN productAttribute pt ON pd.tasteId = pt.attributeId
            LEFT JOIN productAttribute pk ON pd.kindId = pk.attributeId
            LEFT JOIN productAttribute pv ON pd.versionId = pv.attributeId
        WHERE
            pd.productId = #{productId}
    </select>

    <!--查询商品库跟销量-->
    <select id="findSalesInventory" resultType="cn.xgtd.domain.product.ProductDetails">
        SELECT ProductInventory,ProductSales
         FROM ProductPrice
         WHERE ProductId=#{productId};
    </select>
    
    
    <!--查询商品分类-->
    <select id="findCategory" resultMap="findCategoryPrimaryMap">
          SELECT
            ppc.product_primary_id,
            ppc.category_content,
            psc.product_secondary_id,
            psc.secondary_content,
            pfc.product_final_id,
            pfc.final_content
        FROM
        product_primary_category ppc
        LEFT JOIN product_secondary_category psc ON ppc.product_primary_id = psc.product_primary_id
        LEFT JOIN product_final_category pfc ON psc.product_secondary_id = pfc.product_secondary_id
    </select>

    <!--添加商品基本信息-->
    <insert id="addProduct" parameterType="cn.xgtd.domain.product.ProductDetails" useGeneratedKeys="true" keyProperty="productId" keyColumn="ProductId">
        insert into ProductBasis
         <trim prefix="(" suffix=")" suffixOverrides=",">
            ProductName,
            ProductVideo,
            ProductWeight,
            prodcutPrimaryCategory,
            productSecondaryCategory,
            productFinalCategory,
            <if test="productDescription!=null ">productDescription,</if>
            <if test="productAfterSale!=null">productAfterSale,</if>
            <if test="productParameter!=null ">productParameter</if>
         </trim>
        VALUES
            <trim prefix="(" suffix=")" suffixOverrides=",">
                #{productName},#{video},#{weight},#{productClassify.productPrimaryId},
                #{productClassify.productSecondaryId},#{productClassify.productFinalId},
                <if test="productDescription!=null ">#{productDescription},</if>
                <if test="productAfterSale!=null">#{productAfterSale},</if>
                <if test="productParameter!=null ">#{productParameter}</if>
            </trim>
    </insert>
    
    <!--添加商品图片-->
     <insert id="addProductImage">
        INSERT INTO ProductImage
            (ProductId,ImageSite,sign)
        VALUES
         <foreach collection="list" item="item" index="index" separator=",">
            (#{item.productId},
            #{item.imageSite},
            #{item.sign})
        </foreach>
     </insert>

    <!--添加商品-->
     <insert id="addProductContext">
        INSERT INTO productAttribute
            (attributeContent,attributeType,productId)
        VALUES
         <foreach collection="list" item="item" index="index" separator=",">
            (#{item.attributeContent},
            #{item.attributeType},
            #{item.productId})
        </foreach>
     </insert>
     
     <!--查询商品属性种类-->
     <select id="findAttributeType" resultType="cn.xgtd.domain.product.AttributeType">
        SELECT * FROM attributeType
     </select>
     
     
     <!--查询商品配置-->
     <select id="findProductAttribute" resultMap="productContextMap">
        SELECT * FROM productAttribute WHERE productId = #{productId}
      </select>

      <!--新增商品配置组合-->
      <insert id="addDistinction" parameterType="cn.xgtd.domain.product.Distinction">

          INSERT INTO productDistinction
            <trim prefix="(" suffix=")" suffixOverrides=",">
                    productId,
                    <if test="list[0].sizeId != null">sizeId,</if>
                    <if test="list[0].colourId != null">colourId,</if>
                    <if test="list[0].comboId != null">comboId,</if>
                    <if test="list[0].specificationId != null">specificationId,</if>
                    <if test="list[0].tasteId != null">tasteId,</if>
                    <if test="list[0].kindId != null">kindId,</if>
                    <if test="list[0].versionIfId != null">versionId</if>
                </trim>
            values
       <foreach collection="list" item="item" index="index" separator=",">
                  <trim prefix=" (" suffix=")" suffixOverrides=",">
                        #{item.productId},
                        <if test="item.sizeId != null">
                             #{item.sizeId},
                        </if>
                        <if test="item.colourId != null">
                            #{item.colourId},
                         </if>
                        <if test="item.comboId != null">
                            #{item.comboId},
                        </if>
                        <if test="item.specificationId != null">
                             #{item.specificationId},</if>
                        <if test="item.tasteId != null">
                            #{item.tasteId},
                        </if>
                        <if test="item.kindId != null">
                                #{item.kindId},
                         </if>
                        <if test="item.versionIfId != null">
                                #{item.versionIfId},
                        </if>
                    </trim>
      </foreach>


       </insert>

</mapper>